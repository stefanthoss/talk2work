
<div id="map-canvas" style="float: left; width: 70%; height: 700px;"></div>
<div style="float: right; width: 30%; background-color: #F4F4F4; height: 700px;">
  <div style="padding: 20px;">
    <p><b>Add a person to your commute by clicking on the map markers.</b></p><br />
    <p style="color: #34AAE7; font-weight: bold;">People joining your ride:</p>
    <ul id="rider_list">
    </ul><br />
    <button id="confirm-button" type="button" style="width: 260px; height: 50px; margin: 0 auto; color: white; background-color: #9FC54D; border: none;">Confirm</button>
  </div>
</div>

<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
<script type="text/javascript">
  var map;
  var marker_image;

  var start;
  var end;
  var waypoints = [];

  var directionsDisplay;
  var directionsService = new google.maps.DirectionsService();

  function loadMarkers(coords) {
    var infowindow = new google.maps.InfoWindow;
    var marker, i;

    for(i = 0; i < coords.length; i++){
      marker = new google.maps.Marker({
        position: new google.maps.LatLng(coords[i]["lat"], coords[i]["lon"]),
        map: map,
        icon: marker_image
      });
        
      var contentString = '<div id="content"><div id="bodyContent">' +
        '<p><b>Wants to talk about: </b>' + coords[i]["talkingpoint"] + '</p>' +
        '</div></div>';

      google.maps.event.addListener(marker, 'click', (function(marker, i) {
        return function() {
          // add person to right sidebar
          if ( $("#rider_list li:contains('" + coords[i]["name"] + "')").length ) {
            // value already exists in the list -> do nothing
          } else {
            $("#rider_list").append("<li><b>" + coords[i]["name"] + "</b> <a href='#' class='remove-li'>[x]</a><br />" +
              "Wants to talk about " + coords[i]['talkingpoint'] + "</li>");
            waypoints.push({ location: new google.maps.LatLng(coords[i]["lat"], coords[i]["lon"]), stopover: false});
            calculateRoute();
          }
        }
      })(marker, i));
      google.maps.event.addListener(marker, 'mouseover', (function(marker, i) {
        return function() {
          infowindow.setContent(contentString);
          infowindow.open(map, marker);
        }
      })(marker, i));
      google.maps.event.addListener(marker, 'mouseout', (function(marker, i) {
        return function() {
          infowindow.close(map, marker);
        }
      })(marker, i));
    }
  }

  function calculateRoute() {
    var request = {
      origin: start,
      destination: end,
      waypoints: waypoints,
      travelMode: google.maps.TravelMode.DRIVING,
      optimizeWaypoints: true
    };
    directionsService.route(request, function(result, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(result);
      }
    });
  }

  function initialize() {
    /* init map */
    var mapOptions = {
      center: new google.maps.LatLng(37.783333, -122.416667),
      zoom: 8,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);

    marker_image = {
      url: '/img/ic_location.png',
      size: new google.maps.Size(30, 40),
      scaledSize: new google.maps.Size(23, 30),
      origin: new google.maps.Point(0, 0),
      anchor: new google.maps.Point(0, 32)
    };

    /* load markers */
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/match_data.json', true);
    xhr.onload = function() {
      loadMarkers(JSON.parse(this.responseText));
    };
    xhr.send();

    /* load commute route */
    directionsDisplay = new google.maps.DirectionsRenderer();
    directionsDisplay.setMap(map);
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/commute_data.json', true);
    xhr.onload = function() {
      route_data = JSON.parse(this.responseText)
      start = new google.maps.LatLng(route_data["home"][0], route_data["home"][1]);
      end = new google.maps.LatLng(route_data["work"][0], route_data["work"][1]);
      calculateRoute();
    };
    xhr.send();
  }

  /* load jQuery */
  $(function() {
    $("#rider_list").on("click", ".remove-li", function() {
      $(this).closest("li").remove();
    });

    $('#confirm-button').click(function() {
      window.location = "/confirm";
    });
});

  google.maps.event.addDomListener(window, 'load', initialize);
</script>